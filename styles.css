@layer tokens, base, components, utilities;

@layer tokens {
  :root {
    /* Colors - HSL for easy theming */
    --bg-0: hsl(0 0% 10%);
    --bg-1: hsl(0 0% 15%);
    --bg-2: hsl(0 0% 20%);
    --bg-3: hsl(0 0% 25%);
    --text-0: hsl(0 0% 98%);
    --text-1: hsl(0 0% 65%);
    --accent: hsl(18 100% 60%);
    --accent-hover: hsl(18 100% 70%);
    --accent-weak: hsl(18 100% 70%);
    --ok: hsl(120 100% 45%);
    --border: hsl(0 0% 28%);

    /* Typography */
    --ff: system-ui, -apple-system, sans-serif;
    --fs-xs: 11px;
    --fs-sm: 12px;
    --fs-md: 14px;
    --fs-lg: 16px;
    --fs-xl: 20px;

    /* Spacing */
    --space-1: 4px;
    --space-2: 8px;
    --space-3: 12px;
    --space-4: 16px;
    --space-6: 24px;
    --space-8: 32px;

    /* Radii */
    --radius-1: 2px;
    --radius-2: 4px;
    --radius-3: 8px;

    /* Controls */
    --step-size: 44px; /* WCAG 2.2 target size */
    --transition: 120ms ease;
  }
}

@layer base {
  :root {
    color-scheme: dark;
    background: var(--bg-0);
    color: var(--text-0);
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: var(--ff);
    font-size: var(--fs-md);
    overflow-x: hidden;
  }

  button {
    font-family: inherit;
  }

  #app {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }

  /* Focus styles */
  :focus-visible {
    outline: 2px solid var(--accent-weak);
    outline-offset: 2px;
  }
}

@layer components {
  /* Header */
  header {
    background: var(--bg-1);
    border-bottom: 1px solid var(--border);
    padding: var(--space-4);
    display: flex;
    align-items: center;
    gap: var(--space-6);
    flex-wrap: wrap;
  }

  .logo {
    font-size: var(--fs-xl);
    font-weight: bold;
    color: var(--accent);
    margin-right: auto;
  }

  .transport-group {
    display: flex;
    gap: var(--space-2);
  }

  .master-controls {
    display: flex;
    gap: var(--space-4);
  }

  .control-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
  }

  .control-group label {
    font-size: var(--fs-xs);
    color: var(--text-1);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .slider-container {
    display: flex;
    align-items: center;
    gap: var(--space-2);
  }

  .value-display {
    font-size: var(--fs-sm);
    color: var(--text-0);
    min-width: 3ch;
  }

  /* Buttons */
  .control-btn {
    padding: var(--space-2) var(--space-4);
    font-size: var(--fs-md);
    background: var(--accent);
    border: none;
    color: white;
    cursor: pointer;
    border-radius: var(--radius-2);
    font-weight: 600;
    transition: background var(--transition), transform var(--transition);
    min-width: 80px;
    min-height: var(--step-size);
  }

  .control-btn:hover:not(:disabled) {
    background: var(--accent-hover);
  }

  .control-btn:active:not(:disabled) {
    transform: scale(0.98);
  }

  .control-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .control-btn.secondary {
    background: var(--bg-2);
    color: var(--text-0);
    border: 1px solid var(--border);
  }

  .control-btn.secondary:hover:not(:disabled) {
    background: var(--bg-3);
  }

  /* Range inputs */
  input[type="range"] {
    width: 120px;
    height: 4px;
    background: var(--bg-3);
    border-radius: var(--radius-1);
    outline: none;
    -webkit-appearance: none;
  }

  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 16px;
    height: 16px;
    background: var(--accent);
    border-radius: 50%;
    cursor: pointer;
    transition: transform var(--transition);
  }

  input[type="range"]::-webkit-slider-thumb:hover {
    transform: scale(1.2);
  }

  input[type="range"]::-moz-range-thumb {
    width: 16px;
    height: 16px;
    background: var(--accent);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    transition: transform var(--transition);
  }

  input[type="range"]::-moz-range-thumb:hover {
    transform: scale(1.2);
  }

  /* Main content */
  .main-content {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: var(--space-4);
    padding: var(--space-4);
    flex: 1;
    container-type: inline-size;
  }

  /* VST Panel */
  .vst-panel {
    background: var(--bg-1);
    border: 1px solid var(--border);
    border-radius: var(--radius-3);
    padding: var(--space-4);
  }

  .section-title,
  .panel-title {
    font-size: var(--fs-sm);
    color: var(--text-1);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: var(--space-3);
  }

  /* Sequencer */
  .sequencer-section {
    container-type: inline-size;
  }

  #sequencer {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: var(--space-2);
  }

  .sequencer-row {
    display: grid;
    grid-template-columns: subgrid;
    grid-column: 1 / -1;
    align-items: center;
    gap: var(--space-2);
  }

  @supports not (grid-template-columns: subgrid) {
    .sequencer-row {
      grid-template-columns: auto repeat(16, var(--step-size));
    }
  }

  .voice-label {
    font-size: var(--fs-sm);
    color: var(--text-1);
    font-weight: 600;
    min-width: 3ch;
    cursor: pointer;
    padding: var(--space-1);
    border-radius: var(--radius-1);
    transition: background var(--transition), color var(--transition);
  }

  .voice-label:hover {
    background: var(--bg-2);
    color: var(--text-0);
  }

  .voice-label.selected {
    background: var(--accent);
    color: white;
  }

  .steps-container {
    display: grid;
    grid-template-columns: repeat(16, var(--step-size));
    gap: var(--space-2);
  }

  .step-btn {
    width: var(--step-size);
    height: var(--step-size);
    border-radius: var(--radius-2);
    border: 1px solid var(--border);
    background: var(--bg-2);
    cursor: pointer;
    transition: transform var(--transition), opacity var(--transition), background-color var(--transition);
    position: relative;
  }

  .step-btn:hover {
    background: var(--bg-3);
  }

  .step-btn.active {
    background: var(--accent);
    border-color: var(--accent);
  }

  .step-btn.current::after {
    content: '';
    position: absolute;
    inset: -2px;
    border: 2px solid var(--ok);
    border-radius: var(--radius-2);
    pointer-events: none;
  }

  .sequencer-row:has(.step-btn.active) {
    outline: 1px solid color-mix(in srgb, var(--accent) 40%, transparent);
    border-radius: var(--radius-2);
  }

  /* Sidebar */
  .sidebar {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  .panel {
    background: var(--bg-1);
    border: 1px solid var(--border);
    border-radius: var(--radius-3);
    padding: var(--space-4);
  }

  /* Mixer */
  #mixer {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  .mixer-channel {
    display: flex;
    align-items: center;
    gap: var(--space-2);
  }

  .mixer-label {
    font-size: var(--fs-xs);
    color: var(--text-1);
    min-width: 2ch;
  }

  .mixer-slider {
    flex: 1;
  }

  /* Voice params */
  #voice-params {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  .param-control {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
  }

  .param-label {
    font-size: var(--fs-xs);
    color: var(--text-1);
    text-transform: uppercase;
  }

  /* Info */
  .info-content {
    font-size: var(--fs-sm);
    color: var(--text-1);
    line-height: 1.6;
  }

  .info-content strong {
    color: var(--text-0);
  }

  .voice-list {
    font-family: monospace;
    color: var(--accent);
    margin: var(--space-2) 0;
  }

  .info-content kbd {
    background: var(--bg-2);
    border: 1px solid var(--border);
    border-radius: var(--radius-1);
    padding: 2px 6px;
    font-size: var(--fs-xs);
    color: var(--text-0);
  }

  /* Footer */
  footer {
    background: var(--bg-1);
    border-top: 1px solid var(--border);
    padding: var(--space-3) var(--space-4);
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: var(--fs-sm);
    color: var(--text-1);
  }

  .status {
    display: flex;
    gap: var(--space-2);
  }

  .help-btn {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-1);
    padding: var(--space-1) var(--space-3);
    border-radius: var(--radius-2);
    cursor: pointer;
    font-size: var(--fs-xs);
    transition: background var(--transition), color var(--transition);
  }

  .help-btn:hover {
    background: var(--bg-2);
    color: var(--text-0);
  }

  /* Help overlay */
  .help-overlay {
    position: fixed;
    inset: 0;
    background: hsl(0 0% 0% / 0.8);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(4px);
  }

  .help-overlay.visible {
    display: flex;
  }

  .help-content {
    background: var(--bg-1);
    border: 1px solid var(--border);
    border-radius: var(--radius-3);
    padding: var(--space-6);
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
  }

  .help-content h2 {
    font-size: var(--fs-xl);
    color: var(--accent);
    margin-bottom: var(--space-4);
  }

  .help-content h3 {
    font-size: var(--fs-md);
    color: var(--text-0);
    margin-top: var(--space-4);
    margin-bottom: var(--space-2);
  }

  .help-content ul {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }

  .help-content li {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-2);
    background: var(--bg-2);
    border-radius: var(--radius-2);
  }

  .help-content kbd {
    background: var(--bg-3);
    border: 1px solid var(--border);
    border-radius: var(--radius-1);
    padding: var(--space-1) var(--space-2);
    font-size: var(--fs-sm);
    color: var(--accent);
    font-family: monospace;
  }

  /* Pattern selector */
  #pattern-selector {
    display: flex;
    gap: var(--space-1);
  }

  .pattern-btn {
    width: 32px;
    height: 32px;
    border-radius: var(--radius-2);
    border: 1px solid var(--border);
    background: var(--bg-2);
    color: var(--text-1);
    cursor: pointer;
    font-size: var(--fs-sm);
    font-weight: 600;
    transition: background var(--transition), color var(--transition), transform var(--transition);
  }

  .pattern-btn:hover {
    background: var(--bg-3);
    color: var(--text-0);
  }

  .pattern-btn.active {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
  }

  .pattern-btn:active {
    transform: scale(0.95);
  }
}

@layer utilities {
  /* Container queries for responsive design */
  @container (width < 920px) {
    .steps-container {
      gap: var(--space-1);
    }

    .main-content {
      grid-template-columns: 1fr;
    }
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }

  /* Touch devices */
  @media (hover: none), (pointer: coarse) {
    .step-btn {
      width: 48px;
      height: 48px;
    }

    .steps-container {
      grid-template-columns: repeat(16, 48px);
    }
  }
}
